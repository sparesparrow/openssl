name: Basic Validation - Simplified

on:
  pull_request:
    paths:
      - '*.py'
      - '*.yml'
      - '*.yaml'
      - 'conanfile.py'
      - 'VERSION.dat'
      - 'Configure'
      - 'config'
      - '.github/workflows/**'
      - 'conan-profiles/**'
  push:
    branches: [main, master, openssl-3.*]
    paths:
      - '*.py'
      - '*.yml'
      - '*.yaml'
      - 'conanfile.py'
      - 'VERSION.dat'
      - 'Configure'
      - 'config'
      - '.github/workflows/**'
      - 'conan-profiles/**'
  workflow_dispatch:

jobs:
  basic-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Quick validation
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install conan>=2.0
          pip install pyyaml
      
      - name: Validate conanfile.py syntax
        run: |
          echo "üîç Validating conanfile.py syntax..."
          if [ ! -f "conanfile.py" ]; then
            echo "‚ùå conanfile.py not found"
            exit 1
          fi
          
          python -m py_compile conanfile.py
          if [ $? -eq 0 ]; then
            echo "‚úÖ conanfile.py syntax is valid"
          else
            echo "‚ùå conanfile.py syntax validation failed"
            exit 1
          fi
      
      - name: Validate YAML files
        run: |
          echo "üîç Validating YAML files..."
          python -c "
          import yaml
          import sys
          import glob
          
          yaml_files = glob.glob('**/*.yml', recursive=True) + glob.glob('**/*.yaml', recursive=True)
          
          for file in yaml_files:
              try:
                  with open(file, 'r') as f:
                      yaml.safe_load(f)
                  print(f'‚úÖ {file} is valid YAML')
              except yaml.YAMLError as e:
                  print(f'‚ùå {file} has YAML syntax error: {e}')
                  sys.exit(1)
          "
      
      - name: Validate VERSION.dat
        run: |
          echo "üîç Validating VERSION.dat..."
          if [ ! -f "VERSION.dat" ]; then
            echo "‚ùå VERSION.dat not found"
            exit 1
          fi
          
          # Check for required fields
          if ! grep -q "MAJOR=" VERSION.dat; then
            echo "‚ùå VERSION.dat missing MAJOR field"
            exit 1
          fi
          
          if ! grep -q "MINOR=" VERSION.dat; then
            echo "‚ùå VERSION.dat missing MINOR field"
            exit 1
          fi
          
          if ! grep -q "PATCH=" VERSION.dat; then
            echo "‚ùå VERSION.dat missing PATCH field"
            exit 1
          fi
          
          echo "‚úÖ VERSION.dat is valid"
      
      - name: Test conanfile.py basic functionality
        run: |
          echo "üîç Testing conanfile.py basic functionality..."
          python -c "
          import sys
          sys.path.append('.')
          from conanfile import OpenSSLConan
          
          # Test basic instantiation
          conan = OpenSSLConan()
          conan.recipe_folder = '.'
          
          # Test version detection
          try:
              conan.set_version()
              print(f'‚úÖ Version detection works: {conan.version}')
          except Exception as e:
              print(f'‚ùå Version detection failed: {e}')
              sys.exit(1)
          
          # Test that the class can be imported and basic attributes exist
          try:
              assert hasattr(conan, 'name')
              assert hasattr(conan, 'version')
              assert hasattr(conan, 'options')
              assert hasattr(conan, 'settings')
              print('‚úÖ Basic class structure is valid')
          except Exception as e:
              print(f'‚ùå Class structure validation failed: {e}')
              sys.exit(1)
          "
      
      - name: Validate Conan profiles
        run: |
          echo "üîç Validating Conan profiles..."
          if [ ! -d "conan-profiles" ]; then
            echo "‚ùå conan-profiles directory not found"
            exit 1
          fi
          
          for profile in conan-profiles/*.profile; do
            if [ -f "$profile" ]; then
              echo "Validating $profile"
              conan profile show --profile="$profile" > /dev/null || {
                echo "‚ùå Profile $profile validation failed"
                exit 1
              }
            fi
          done
          echo "‚úÖ All Conan profiles are valid"
      
      - name: Check essential files exist
        run: |
          echo "üîç Checking essential files exist..."
          required_files=(
            "conanfile.py"
            "VERSION.dat"
            "Configure"
            "config"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing required file: $file"
              exit 1
            else
              echo "‚úÖ Found: $file"
            fi
          done
          
          echo "‚úÖ All essential files present"
      
      - name: Report success
        run: |
          echo "üéâ Basic validation completed successfully!"
          echo "‚úÖ All fundamental components validated:"
          echo "  - conanfile.py syntax valid"
          echo "  - YAML files valid"
          echo "  - VERSION.dat valid"
          echo "  - Conan profiles valid"
          echo "  - Essential files present"
          echo ""
          echo "üöÄ Ready for openssl-tools integration!"